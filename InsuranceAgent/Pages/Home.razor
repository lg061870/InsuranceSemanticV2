@page "/"
@implements IDisposable

@using System.Text.Json
@using ConversaCore.DTO
@using ConversaCore.Events
@using ConversaCore.Interfaces
@using ConversaCore.Services
@using ConversaCore.TopicFlow
@using ConversaCore.TopicFlow.Extensions
@using ConversaCore.UI.Components
@using InsuranceAgent.DomainTypes
@using InsuranceAgent.Models
@using InsuranceAgent.Pages.Components
@using InsuranceAgent.Pages.Components.CustomerConsoleV2
@using InsuranceAgent.Services
@using InsuranceAgent.Topics
@using System.Dynamic
@using System.Reflection
@using InsuranceSemanticV2.Core.DTO
@using AutoMapper;

@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ILogger<Home> Logger
@inject INavigationEventService NavEvents
@inject InsuranceAgentServiceV2 InsuranceAgentService
@* @inject HybridChatService ChatService *@
@inject AutoMapper.IMapper _mapper
@inject LeadsService LeadsService


<div class="flex flex-row w-full h-screen font-sans overflow-hidden">
    <!-- ===========================
         LEFT SECTION (2/3 width)
         =========================== -->
    <div class="relative w-2/3 h-full overflow-hidden">

        <!-- Customer Console -->
        <div class="absolute top-0 left-0 w-full h-full transition-transform duration-500 ease-in-out z-40"
             style="@TranslateX(showCustomerConsole)">
            <CustomerConsoleV2 @ref="customerConsoleRef"
                             IsVisible="@showCustomerConsole"
                             OnClose="@CloseCustomerConsole" />

        </div>

        <!-- Questionnaire -->
        <div class="absolute top-0 left-0 w-full h-full bg-white transition-transform duration-500 ease-in-out z-30"
             style="@TranslateX(currentView == ViewState.Questionnaire)">
            @* Placeholder for QuestionnaireAccordion *@
        </div>

        <!-- Agent Console -->
        <div class="absolute top-0 left-0 w-full h-full transition-opacity duration-500 ease-in-out z-20"
             style="@Opacity(currentView == ViewState.AgentConsole)">
            <AgentConsole />
        </div>

        <!-- Consent Denied -->
        <div class="absolute top-0 left-0 w-full h-full transition-opacity duration-500 ease-in-out z-15"
             style="@Opacity(currentView == ViewState.ConsentDenied)">
            <div class="flex flex-col items-center justify-center h-full p-8 bg-white">
                <div class="max-w-2xl mx-auto p-6 bg-red-50 rounded-lg border border-red-200 text-center">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-shield-xmark text-red-500 text-2xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Consent Required</h2>
                    <p class="text-gray-700 mb-6">@consentDeniedMessage</p>
                    <div class="flex justify-center space-x-4">
                        <button class="px-5 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-800 font-medium transition-colors"
                                @onclick="() => currentView = ViewState.LandingPage">
                            Return to Homepage
                        </button>
                        <button class="px-5 py-2 bg-primary hover:bg-primary-dark rounded-lg text-white font-medium transition-colors"
                                @onclick="RequestConsentAgain">
                            Provide Consent
                        </button>
                    </div>
                    <p class="mt-4 text-sm text-gray-500">
                        If you have questions about our data practices, please review our
                        <a href="#" class="text-primary hover:underline">Privacy Policy</a>.
                    </p>
                </div>
            </div>
        </div>

        <!-- Landing Page -->
        <div class="absolute top-0 left-0 w-full h-full transition-opacity duration-500 ease-in-out z-10"
             style="@Opacity(currentView == ViewState.LandingPage && !showCustomerConsole)">
            <InsuranceLandingPage />
        </div>
    </div>

    <!-- ===========================
         RIGHT SECTION (Chat Window)
         =========================== -->
    <div class="w-1/3 h-full relative flex">
        <div class="flex-1 mx-4 my-2">
            <CustomChatWindowV3 AgentService="@InsuranceAgentService"
                              SubscribeToEvents="@(w => InsuranceAgentService.SubscribeToChatWindowEvents(w))" />
        </div>
    </div>
</div>

<!-- ===========================
     Metadata Container
     =========================== -->
<div id="page-context"
     data-page-id="landing-page"
     data-landing-id="LP-2025-08-13-A"
     data-campaign="august_term_push"
     data-locale="en-US"
     data-tenant="ksl-ai"
     data-environment="prod"
     data-ab-test="variant-b"
     data-ribbon-ui="on"
     data-utm-source="google"
     data-utm-medium="cpc"
     data-utm-campaign="term-insurance-keywords"
     data-referrer-doc="">
</div>

@code {

    #region --- Fields & Enums ---
    private CustomerConsoleV2? customerConsoleRef;

    private enum ViewState { LandingPage, AgentConsole, Questionnaire, ConsentDenied }
    private ViewState currentView = ViewState.LandingPage;

    private bool showCustomerConsole;
    private bool hasConsent;
    private bool stageProfileCollected, stageRiskDone, stageMatching, stageCalculating, isComplete;

    private string userConsentType = string.Empty;
    private string userConsentData = string.Empty;
    private string consentDeniedMessage = "We respect your privacy choice...";
    private string progressMessage = "Initializing...";
    private string progressStage = "Starting workflow...";
    private int progressPercent;
    #endregion

    #region --- Lifecycle ---
    protected override void OnInitialized() {
        // Unsubscribe first to prevent duplicate subscriptions
        NavEvents.NavigateRequested -= OnNavigateRequested;
        InsuranceAgentService.CustomEventTriggered -= OnCustomEventReceived;

        // Now subscribe
        NavEvents.NavigateRequested += OnNavigateRequested;
        InsuranceAgentService.CustomEventTriggered += OnCustomEventReceived;
        Logger.LogInformation("[Home] Initialized and subscribed to events");
    }

    public void Dispose() {
        Logger.LogInformation("[Home] Dispose() — unsubscribing events");
        NavEvents.NavigateRequested -= OnNavigateRequested;
        InsuranceAgentService.CustomEventTriggered -= OnCustomEventReceived;
        _ = JS.InvokeVoidAsync("window.cleanupHomeComponent");
    }
    #endregion

    #region --- Navigation & Events ---
    private Task OnNavigateRequested(string url) {
        Logger.LogInformation("[Home] Navigate requested → {Url}", url);
        return InvokeAsync(() => Nav.NavigateTo(url));
    }

    private async void OnCustomEventReceived(object? sender, CustomEventTriggeredEventArgs e) {
        Logger.LogInformation(
            "[Home] CustomEventTriggered → {Event} | Type={Type}",
            e.EventName,
            e.EventData?.GetType()?.Name
        );

        try {
            var eventName = e.EventName?.Trim().ToLowerInvariant() ?? string.Empty;

            if (e.Context != null)
                lastKnownContext = e.Context;

            // =============================================================
            // 1) Stage-handling
            // =============================================================
            switch (eventName) {
                case "customer_console_show":
                    showCustomerConsole = true;
                    break;

                case "lead_details_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveLeadWithContactInfoAsync(e);
                    break;

                case "life_goals_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveLifeGoalsAsync(e);
                    break;

                case "coverage_intent_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveCoverageIntentAsync(e);
                    break;

                case "health_info_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveHealthInfoAsync(e);
                    break;

                case "dependents_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveDependentsAsync(e);
                    break;

                case "employment_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveEmploymentAsync(e);
                    break;

                case "beneficiaries_submitted":
                    HandleProgressUpdate(e.EventData);
                    await SaveBeneficiariesAsync(e);
                    break;

                case "contact_info_submitted":
                    HandleProgressUpdate(e.EventData);
                    // await SaveContactInfoAsync(e);
                    break;

                case "qualification_complete":
                    HandleProgressComplete(e.EventData);
                    break;
            }


            // =============================================================
            // 2) Extract payload for CustomerConsole
            // =============================================================
            object? payload = null;

            try {
                var dict = DecodeEventData(e.EventData);

                if (dict != null && dict.TryGetValue("payload", out var raw)) {
                    payload = raw switch {
                        JsonElement elem => JsonSerializer.Deserialize<QualifiedCarriers>(elem.GetRawText()),
                        string s => JsonSerializer.Deserialize<QualifiedCarriers>(s),
                        QualifiedCarriers qc => qc,
                        IEnumerable<CarrierEligibility> list => new QualifiedCarriers {
                            Carriers = list.ToList()
                        },
                        _ => raw
                    };
                }
            } catch (Exception ex2) {
                Logger.LogWarning(ex2, "[Home] Failed to extract payload for {Event}", e.EventName);
            }

            // =============================================================
            // 3) Forward to CustomerConsole
            // =============================================================
            if (showCustomerConsole && customerConsoleRef is not null) {
                await customerConsoleRef.UpdateFromChatEvent(
                    e.EventName,
                    payload ?? e.EventData,
                    e.Context
                );
            }
        } catch (Exception ex) {
            Logger.LogError(ex, "[Home] Exception while processing custom event {Event}", e.EventName);
        }

        _ = InvokeAsync(StateHasChanged);
    }


    #endregion

    #region --- Progress Handlers ---
    private void HandleProgressUpdate(object? data) {
        try {
            var dict = DecodeEventData(data);
            if (dict is null)
                return;

            UpdateProgressFromDictionary(dict);
        } catch (Exception ex) {
            Logger.LogError(ex, "[Home] Error parsing progress update event");
        }
    }

    private static bool IsAnonymousType(Type t) =>
        Attribute.IsDefined(t, typeof(System.Runtime.CompilerServices.CompilerGeneratedAttribute), false)
        && t.IsGenericType && t.Name.Contains("AnonymousType")
        && t.Name.StartsWith("<>")
        && t.Attributes.HasFlag(TypeAttributes.NotPublic);

    /// <summary>
    /// Converts ANY incoming event payload into a dictionary<string, object>.
    /// Handles: anonymous objects, ExpandoObject, Dictionary, JSON, JsonElement,
    /// UiProgressEvent, and strongly typed POCOs.
    /// </summary>
    private static Dictionary<string, object>? DecodeEventData(object? data) {
        if (data is null)
            return null;

        // ---------- 1. Anonymous type ----------
        var t = data.GetType();
        if (IsAnonymousType(t)) {
            return t.GetProperties().ToDictionary(
                p => p.Name,
                p => p.GetValue(data)!
            );
        }

        // ---------- 2. UiProgressEvent ----------
        if (data is UiProgressEvent dto) {
            return new() {
                ["stage"] = dto.Stage,
                ["progress"] = dto.Progress,
                ["message"] = dto.Message,
                ["nextStep"] = dto.NextStep,
                ["payload"] = dto.Payload
            };
        }

        // ---------- 3. ExpandoObject ----------
        if (data is ExpandoObject exp) {
            var d = new Dictionary<string, object>();
            foreach (var kv in exp)
                d[kv.Key] = kv.Value!;
            return d;
        }

        // ---------- 4. Dictionary ----------
        if (data is IDictionary<string, object> dict) {
            return new Dictionary<string, object>(dict);
        }

        // ---------- 5. JSON string ----------
        if (data is string jsonStr && jsonStr.TrimStart().StartsWith("{")) {
            return JsonDocument.Parse(jsonStr)
                .RootElement
                .EnumerateObject()
                .ToDictionary(
                    x => x.Name,
                    x => (object)x.Value.ToString()
                );
        }

        // ---------- 6. JsonElement ----------
        if (data is JsonElement elem && elem.ValueKind == JsonValueKind.Object) {
            return elem
                .EnumerateObject()
                .ToDictionary(
                    x => x.Name,
                    x => (object)x.Value.ToString()
                );
        }

        // ---------- 7. Fallback: reflect POCO ----------
        var props = t.GetProperties();
        if (props.Length > 0) {
            return props.ToDictionary(
                p => p.Name,
                p => p.GetValue(data) ?? ""
            );
        }

        return null;
    }

    private void HandleProgressComplete(object? data) {
        progressPercent = 100;
        progressMessage = "Qualification Complete!";
        progressStage = "Your results are ready.";
        isComplete = true;
        _ = InvokeAsync(StateHasChanged);
        Logger.LogInformation("[Home] ✅ Progress complete");
    }

    private void UpdateProgressFromDictionary(Dictionary<string, object> dict) {
        if (dict.TryGetValue("progress", out var pObj) && int.TryParse(pObj?.ToString(), out var progress))
            progressPercent = progress;

        progressStage = dict.TryGetValue("stage", out var sObj) ? sObj?.ToString() ?? "" : "";
        progressMessage = dict.TryGetValue("message", out var mObj) ? mObj?.ToString() ?? "" : "Processing...";

        stageProfileCollected = progressPercent >= 25;
        stageRiskDone = progressPercent >= 50;
        stageMatching = progressPercent >= 70;
        stageCalculating = progressPercent >= 85;
        isComplete = progressPercent >= 100;

        Logger.LogInformation("[Home] Progress {Percent}% | Stage={Stage}", progressPercent, progressStage);
        _ = InvokeAsync(StateHasChanged);
    }

    private async Task SaveLeadWithContactInfoAsync(CustomEventTriggeredEventArgs e) {
        try {
            // Extract both models from context
            var leadModel = e.Context?.GetValue<LeadDetailsModel>("LeadDetailsModel");
            var contactModel = e.Context?.GetValue<ContactInfoModel>("ContactInfoModel");

            if (leadModel is null) {
                Logger.LogWarning("[Home] LeadDetailsModel not found in context.");
                return;
            }

            // Step 1: Create Lead with basic contact info from ContactInfoModel
            var leadDto = _mapper.Map<LeadRequest>(leadModel);

            // Populate Lead contact fields from ContactInfoModel if available
            if (contactModel != null) {
                leadDto.FullName = contactModel.FullName;
                leadDto.Email = contactModel.EmailAddress;
                leadDto.Phone = contactModel.PhoneNumber;
            }

            // // Only assign AgentId if it's been selected
            // if (InsuranceAgentService.CurrentAgentId is int agentId)
            //     leadDto.AssignedAgentId = agentId;

            // Create Lead and store the auto-generated ID
            var leadId = await LeadsService.CreateLeadAsync(leadDto);
            if (!leadId.HasValue) {
                Logger.LogError("[Home] Failed to create lead - no ID returned.");
                return;
            }

            currentLeadId = leadId.Value;
            Logger.LogInformation("[Home] Lead created with ID: {LeadId}", leadId.Value);

            // Step 2: Save detailed ContactInfo to profile (if available)
            if (contactModel != null) {
                var contactDto = _mapper.Map<ContactInfoRequest>(contactModel);
                contactDto.LeadId = leadId.Value;
                await LeadsService.SaveContactInfoAsync(contactDto);
                Logger.LogInformation("[Home] ContactInfo saved for LeadId: {LeadId}", leadId.Value);
            }

        } catch (Exception ex) {
            Logger.LogError(ex, "[Home] Failed to save lead with contact info.");
        }
    }

    private async Task SaveLifeGoalsAsync(CustomEventTriggeredEventArgs e) {
        var model = e.Context?.GetValue<LifeGoalsModel>("LifeGoalsModel");
        if (model is null) {
            Logger.LogWarning("[Home] LifeGoalsModel not found in context.");
            return;
        }

        if (!currentLeadId.HasValue) {
            Logger.LogWarning("[Home] Cannot save LifeGoals: LeadId not available.");
            return;
        }

        var dto = _mapper.Map<LifeGoalsRequest>(model);
        dto.LeadId = currentLeadId.Value;
        await LeadsService.SaveLifeGoalsAsync(dto);
    }

    private async Task SaveCoverageIntentAsync(CustomEventTriggeredEventArgs e) {
        var model = e.Context?.GetValue<CoverageIntentModel>("CoverageIntentModel");
        if (model is null) {
            Logger.LogWarning("[Home] CoverageIntentModel not found in context.");
            return;
        }

        if (!currentLeadId.HasValue) {
            Logger.LogWarning("[Home] Cannot save CoverageIntent: LeadId not available.");
            return;
        }

        var dto = _mapper.Map<CoverageIntentRequest>(model);
        dto.LeadId = currentLeadId.Value;
        await LeadsService.SaveCoverageIntentAsync(dto);
    }

    private async Task SaveHealthInfoAsync(CustomEventTriggeredEventArgs e) {
        var model = e.Context?.GetValue<HealthInfoModel>("HealthInfoModel");
        if (model is null) {
            Logger.LogWarning("[Home] HealthInfoModel not found in context.");
            return;
        }

        if (!currentLeadId.HasValue) {
            Logger.LogWarning("[Home] Cannot save HealthInfo: LeadId not available.");
            return;
        }

        var dto = _mapper.Map<HealthInfoRequest>(model);
        dto.LeadId = currentLeadId.Value;
        await LeadsService.SaveHealthInfoAsync(dto);
    }

    private async Task SaveDependentsAsync(CustomEventTriggeredEventArgs e) {
        var model = e.Context?.GetValue<DependentsModel>("DependentsModel");
        if (model is null) {
            Logger.LogWarning("[Home] DependentsModel not found in context.");
            return;
        }

        if (!currentLeadId.HasValue) {
            Logger.LogWarning("[Home] Cannot save Dependents: LeadId not available.");
            return;
        }

        var dto = _mapper.Map<DependentsRequest>(model);
        dto.LeadId = currentLeadId.Value;
        await LeadsService.SaveDependentsAsync(dto);
    }

    private async Task SaveEmploymentAsync(CustomEventTriggeredEventArgs e) {
        var model = e.Context?.GetValue<EmploymentModel>("EmploymentModel");
        if (model is null) {
            Logger.LogWarning("[Home] EmploymentModel not found in context.");
            return;
        }

        if (!currentLeadId.HasValue) {
            Logger.LogWarning("[Home] Cannot save Employment: LeadId not available.");
            return;
        }

        var dto = _mapper.Map<EmploymentRequest>(model);
        dto.LeadId = currentLeadId.Value;
        await LeadsService.SaveEmploymentAsync(dto);
    }

    private async Task SaveBeneficiariesAsync(CustomEventTriggeredEventArgs e) {
        var model = e.Context?.GetValue<BeneficiaryInfoModel>("BeneficiaryInfoModel");
        if (model is null) {
            Logger.LogWarning("[Home] BeneficiaryInfoModel not found in context.");
            return;
        }

        if (!currentLeadId.HasValue) {
            Logger.LogWarning("[Home] Cannot save Beneficiaries: LeadId not available.");
            return;
        }

        var dto = _mapper.Map<BeneficiaryInfoRequest>(model);
        dto.LeadId = currentLeadId.Value;
        await LeadsService.SaveBeneficiariesAsync(dto);
    }

    // private async Task SaveContactInfoAsync(CustomEventTriggeredEventArgs e) {
    //     var model = e.Context?.GetValue<ContactInfoModel>("ContactInfoModel");
    //     if (model is null) {
    //         Logger.LogWarning("[Home] ContactInfoModel not found in context.");
    //         return;
    //     }

    //     if (!currentLeadId.HasValue) {
    //         Logger.LogWarning("[Home] Cannot save ContactInfo: LeadId not available.");
    //         return;
    //     }

    //     var dto = _mapper.Map<ContactInfoRequest>(model);
    //     dto.LeadId = currentLeadId.Value;
    //     await LeadsService.SaveContactInfoAsync(dto);
    // }



    #endregion

    #region --- UI Actions ---
    private async Task CloseCustomerConsole() {
        showCustomerConsole = false;
        await InvokeAsync(StateHasChanged);
        Logger.LogInformation("[Home] Customer console closed");
    }

    private async Task RequestConsentAgain() {
        currentView = ViewState.LandingPage;
        Logger.LogInformation("[Home] User retried consent");
        await JS.InvokeVoidAsync("sendEventToBot", "requestConsentForm", new { retry = true });
    }
    #endregion

    #region --- Helpers ---
    private static string TranslateX(bool condition) => condition ? "transform: translateX(0);" : "transform: translateX(-100%);";
    private static string Opacity(bool visible) => visible ? "opacity: 1;" : "opacity: 0; pointer-events: none;";
    #endregion

    #region --- Data Models ---
    private TopicWorkflowContext? lastKnownContext;
    private LeadDetailsModel? leadDetailsModel;
    private int? currentLeadId;
    #endregion
}
