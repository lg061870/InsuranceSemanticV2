@using ConversaCore.TopicFlow
@using InsuranceSemanticV2.Core.DTO
@using System.Net.Http.Json
@inject HttpClient Http

<div id="live-agent-panel" 
     class="tab-content p-8 overflow-y-auto max-h-[85vh] @(ActiveTab != "live-agent" ? "hidden" : "")">

    <!-- Header -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Connect with Live Agent</h2>
        <p class="text-sm text-gray-600">Transfer to a human agent for personalized assistance and complex inquiries</p>
    </div>

    <!-- MAIN GRID -->
    <div class="grid grid-cols-3 gap-6 mb-6">

        <!-- LEFT SIDE – AGENTS + COMPLIANCE -->
        <div class="col-span-2">

            <!-- Available Agents Panel -->
            <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">

                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fa-solid fa-user-tie text-blue-600 mr-3 text-2xl"></i>
                        Available Agents Ready to Connect
                    </h3>

                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                        <span class="text-sm font-semibold text-green-600">@Agents.Count Agents Online</span>
                    </div>
                </div>

                <!-- Agent Cards -->
                <div class="grid grid-cols-2 gap-5">
                    @foreach (var agent in Agents) {
                        <div class="bg-white border border-gray-200 rounded-xl p-5 hover:border-blue-300 hover:shadow-md transition-all">
                            <div class="flex items-start space-x-4">

                                <img src="@agent.AvatarUrl"
                                     alt="@agent.FullName"
                                     class="w-16 h-16 rounded-full border-2 border-gray-200">

                                <div class="flex-1">
                                    <div class="flex items-start justify-between mb-1">
                                        <div>
                                            <h4 class="text-base font-bold text-gray-900">@agent.FullName</h4>
                                            <p class="text-xs text-gray-500">@agent.Specialty</p>
                                        </div>
                                        <span class="px-2 py-1 @GetStatusBadgeColor(agent.StatusColor) text-xs font-semibold rounded-full">
                                            @agent.StatusLabel
                                        </span>
                                    </div>

                                    <div class="flex items-center space-x-3 mt-3 text-xs text-gray-600">
                                        <div class="flex items-center">
                                            <i class="fa-solid fa-star text-yellow-400 mr-1"></i>
                                            <span class="font-semibold">@agent.Rating.ToString("F1")</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fa-solid fa-phone text-gray-400 mr-1"></i>
                                            <span>@agent.Calls calls</span>
                                        </div>
                                        <div class="flex items-center">
                                            <i class="fa-solid fa-clock text-gray-400 mr-1"></i>
                                            <span>~@agent.AvgMinutes min</span>
                                        </div>
                                    </div>

                                    @if (agent.IsAvailable) {
                                        <button class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 rounded-lg text-sm transition-colors">
                                            <i class="fa-solid fa-phone mr-2"></i>
                                            Connect Now
                                        </button>
                                    }
                                    else {
                                        <button class="w-full mt-3 bg-gray-100 text-gray-500 font-medium py-2 rounded-lg text-sm cursor-not-allowed" disabled>
                                            <i class="fa-solid fa-clock mr-2"></i>
                                            Currently Unavailable
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Compliance Notice -->
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-6">
                <div class="flex items-start space-x-4">

                    <div class="w-12 h-12 bg-amber-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-info-circle text-amber-600 text-xl"></i>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">Important Compliance Notice</h3>
                        <p class="text-sm text-gray-700 mb-3">Before initiating contact with the client, please ensure:</p>

                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start">
                                <i class="fa-solid @GetComplianceIcon("tcpa_consent") mr-2 mt-0.5"></i>
                                <span>TCPA consent: <strong>@GetTcpaStatus()</strong></span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa-solid fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span>Client's preferred contact method and time have been respected</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa-solid fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span>All regulatory disclosures are ready to be provided during the call</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fa-solid fa-check text-green-600 mr-2 mt-0.5"></i>
                                <span>Call recording and documentation systems are active and compliant</span>
                            </li>
                        </ul>

                    </div>
                </div>
            </div>

        </div>

        <!-- RIGHT SIDE – IMMEDIATE CONNECT + CALLBACK -->
        <div class="col-span-1 space-y-6">

            <!-- Immediate Connection Panel -->
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-start space-x-3 mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-bolt text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-1">Immediate Connection</h3>
                        <p class="text-xs text-gray-500">Connect with an available agent right now</p>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-lg p-4 mb-4 space-y-2">

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Client Name</span>
                        <span class="text-sm font-semibold text-gray-900">@GetClientName()</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Phone</span>
                        <span class="text-sm font-semibold text-gray-900">@GetClientPhone()</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Email</span>
                        <span class="text-sm font-semibold text-gray-900">@GetClientEmail()</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Client Path</span>
                        <span class="text-sm font-semibold text-gray-900">@GetLeadPath()</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Agents Online</span>
                        <span class="text-sm font-semibold text-green-600">@Agents.Count</span>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">Avg. Wait Time</span>
                        <span class="text-sm font-semibold text-gray-900">@GetWaitEstimate()</span>
                    </div>
                </div>

                <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">
                    <i class="fa-solid fa-phone mr-2"></i>
                    Connect Now
                </button>
            </div>

            <!-- Schedule Callback Panel -->
            <div class="bg-white rounded-xl border border-gray-200 p-6">
                <div class="flex items-start space-x-3 mb-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fa-solid fa-calendar-check text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-1">Schedule Callback</h3>
                        <p class="text-xs text-gray-500">Set up a convenient time for @GetClientName()</p>
                    </div>
                </div>

                <div class="space-y-3 mb-4">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-2">Preferred Date</label>
                        <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-2">Preferred Time</label>
                        <input type="time" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg transition-colors text-sm">
                    <i class="fa-solid fa-calendar-plus mr-2"></i>
                    Schedule Callback
                </button>
            </div>

        </div>

    </div>

</div>

@code {

    [Parameter] public TopicWorkflowContext? Context { get; set; }
    [Parameter] public string ActiveTab { get; set; } = "";

    private List<AgentRequest> Agents { get; set; } = new();

    protected override async Task OnInitializedAsync() {
        try {
            var response = await Http.GetFromJsonAsync<AgentResponse>("api/agents");

            Agents = response?.Payload ?? new List<AgentRequest>();
        } catch (Exception ex) {
            Console.WriteLine($"[TabLiveAgent] ERROR fetching agents: {ex.Message}");
            Agents = new();
        }
    }

    private string GetClientName() =>
        Context?.GetString("full_name") ?? "N/A";

    private string GetTcpaStatus() {
        var tcpa = Context?.GetString("tcpa_consent", "phone_consent") ?? "N/A";
        return tcpa.ToLowerInvariant() switch {
            "yes" or "true" or "granted" => "✓ Granted",
            "no" or "false" or "denied" => "✗ Not Granted",
            _ => "Pending"
        };
    }

    private string GetComplianceIcon(string key) {
        if (Context == null) return "fa-question text-gray-400";

        var value = Context.GetString(key);
        var isGranted = value.ToLowerInvariant() is "yes" or "true" or "granted";

        return isGranted ? "fa-check text-green-600" : "fa-times text-red-600";
    }

    private string GetStatusBadgeColor(string color) {
        return color.ToLowerInvariant() switch {
            "green" => "bg-green-100 text-green-700",
            "yellow" => "bg-yellow-100 text-yellow-700",
            "red" => "bg-red-100 text-red-700",
            _ => "bg-gray-100 text-gray-600"
        };
    }

    private string GetClientPhone() =>
    Context?.GetString("phone_number", "contact_phone", "client_phone") ?? "N/A";

    private string GetClientEmail() =>
        Context?.GetString("email_address", "email", "contact_email") ?? "N/A";

    private string GetLeadPath() =>
        Context?.GetString("marketing_path", "marketing_t1_path", "path_type") ?? "N/A";

    private string GetWaitEstimate() {
        // Later can be dynamic based on queue info
        return "~2 minutes";
    }

}
