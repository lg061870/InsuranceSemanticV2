@using ConversaCore.TopicFlow
@using InsuranceSemanticV2.Core.DTO
@using Microsoft.AspNetCore.Components
@using InsuranceAgent.Models
@inject IHttpClientFactory ClientFactory

<div id="tab-navigation" class="border-b border-gray-200 bg-gray-50">
    <div class="flex">

        <!-- MY INFORMATION -->
        <button @onclick='() => ChangeTab("my-information")'
                class="tab-button flex-1 px-6 py-4 text-sm font-semibold @(IsActive("my-information")
                                    ? "text-blue-600 border-b-2 border-blue-600 bg-white"
                                    : "text-gray-600 hover:text-gray-900 hover:bg-gray-100 border-b-2 border-transparent") transition-all">
            <i class="fa-solid fa-user-circle mr-2"></i>
            My Information
        </button>

        <!-- MATCHED PRODUCTS -->
        <button @onclick='() => ChangeTab("matched-products")'
                class="tab-button flex-1 px-6 py-4 text-sm font-semibold @(IsActive("matched-products")
                                    ? "text-blue-600 border-b-2 border-blue-600 bg-white"
                                    : "text-gray-600 hover:text-gray-900 hover:bg-gray-100 border-b-2 border-transparent") transition-all">
            <i class="fa-solid fa-compass mr-2"></i>
            Matched Products
        </button>

        <!-- COMPLIANCE -->
        <button @onclick='() => ChangeTab("compliance")'
                class="tab-button flex-1 px-6 py-4 text-sm font-semibold @(IsActive("compliance")
                                    ? "text-blue-600 border-b-2 border-blue-600 bg-white"
                                    : "text-gray-600 hover:text-gray-900 hover:bg-gray-100 border-b-2 border-transparent") transition-all">
            <i class="fa-solid fa-file-shield mr-2"></i>
            Compliance
        </button>

        <!-- LIVE AGENT -->
        <button @onclick='() => (AgentCount > 0 ? ChangeTab("live-agent") : Task.CompletedTask)'
                disabled="@(AgentCount == 0)"
                class="
                    tab-button flex-1 px-6 py-4 text-sm font-semibold transition-all
                    @(AgentCount == 0
                                        ? "text-gray-400 cursor-not-allowed bg-gray-100 border-b-2 border-transparent"
                                        : (IsActive("live-agent")
                                            ? "text-blue-600 border-b-2 border-blue-600 bg-white"
                                            : "text-gray-600 hover:text-gray-900 hover:bg-gray-100 border-b-2 border-transparent"))
                ">
            <i class="fa-solid fa-phone mr-2"></i>
            Live Agent
        </button>

    </div>
</div>

<!-- TAB CONTENT RENDERING -->
@if (IsActive("my-information")) {
    <TabMyInformation Context="Context" ActiveTab="@ActiveTab" />
}
else if (IsActive("matched-products")) {
    <TabMatchedProduct Context="Context" ActiveTab="@ActiveTab" MatchedProducts="@MatchedProducts" />
}
else if (IsActive("compliance")) {
    <TabCompliance Context="Context" ActiveTab="@ActiveTab" />
}
else if (IsActive("live-agent")) {
    <TabLiveAgent Context="Context" ActiveTab="@ActiveTab" />
}

@code {

    [Parameter] public TopicWorkflowContext Context { get; set; } = default!;
    [Parameter] public string ActiveTab { get; set; } = "matched-products";
    [Parameter] public List<ProductMatch>? MatchedProducts { get; set; }
    [Parameter] public EventCallback<string> OnTabChanged { get; set; }
    [Parameter] public int AgentCount { get; set; }

    protected override async Task OnInitializedAsync() {
        try {
            var client = ClientFactory.CreateClient("ApiClient");

            // NOTE: relative path (correct)
            var response = await client.GetFromJsonAsync<AgentResponse>("api/agents");

            AgentCount = response?.Payload?.Count ?? 0;
        } catch (Exception ex) {
            Console.WriteLine($"[TabNav] Failed to load agents: {ex.Message}");
            AgentCount = 0;
        }
    }

    private bool IsActive(string tab) =>
        string.Equals(ActiveTab, tab, StringComparison.OrdinalIgnoreCase);

    private async Task ChangeTab(string tab) {
        ActiveTab = tab;

        if (OnTabChanged.HasDelegate)
            await OnTabChanged.InvokeAsync(tab);

        StateHasChanged();
    }
}
