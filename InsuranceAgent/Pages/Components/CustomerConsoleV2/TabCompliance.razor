@using ConversaCore.TopicFlow
@using InsuranceAgent.Extensions

<div id="compliance-panel" class="tab-content p-8 @(ActiveTab != "compliance" ? "hidden" : "")">

    <!-- HEADER -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">Compliance &amp; Consent Management</h2>
        <p class="text-sm text-gray-600">Ensure all regulatory requirements are met before proceeding with client contact</p>
    </div>

    <div class="grid grid-cols-2 gap-6 mb-8">

        <!-- TCPA CONSENT CARD -->
        <div class="bg-white rounded-xl border border-gray-200 p-6">

            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-phone-volume text-green-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">TCPA Consent</h3>
                        <p class="text-xs text-gray-500">Telephone Consumer Protection Act</p>
                    </div>
                </div>

                <span class="px-3 py-1 @GetConsentBadgeClass(Tcpa) text-xs font-bold rounded-full flex items-center">
                    <i class="fa-solid @GetConsentIcon(Tcpa) mr-1"></i>
                    @GetConsentLabel(Tcpa)
                </span>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <p class="text-sm text-gray-700 leading-relaxed mb-3">
                    By providing my phone number and clicking submit, I consent to receive calls, text messages,
                    and pre-recorded messages from Copilot Insurance and its partners regarding insurance products and services.
                </p>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>TCPA Consent: <strong>@Tcpa</strong></span>
                    <span>Timestamp: <strong>@TcpaTimestamp</strong></span>
                </div>
            </div>

            <div class="flex space-x-3">
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-file-lines mr-2"></i> View Full Text
                </button>
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-clock-rotate-left mr-2"></i> View History
                </button>
            </div>

        </div>

        <!-- CCPA CARD -->
        <div class="bg-white rounded-xl border border-gray-200 p-6">

            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-shield-halved text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">CCPA Notice</h3>
                        <p class="text-xs text-gray-500">California Consumer Privacy Act</p>
                    </div>
                </div>

                <span class="px-3 py-1 @GetConsentBadgeClass(Ccpa) text-xs font-bold rounded-full flex items-center">
                    <i class="fa-solid @GetConsentIcon(Ccpa) mr-1"></i>
                    @GetConsentLabel(Ccpa)
                </span>
            </div>

            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                <p class="text-sm text-gray-700 leading-relaxed mb-3">
                    You have the right to know what personal information we collect, request deletion,
                    and opt out of the sale of your data. For more information, please review our privacy policy.
                </p>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>ZIP Code: <strong>@Zip</strong></span>
                    <span>California Resident: <strong>@(IsCA ? "Yes" : "No")</strong></span>
                </div>
            </div>

            <div class="flex space-x-3">
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-file-lines mr-2"></i> View Full Notice
                </button>
                <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 rounded-lg text-sm">
                    <i class="fa-solid fa-link mr-2"></i> Privacy Policy
                </button>
            </div>

        </div>

    </div>

    <!-- ADDITIONAL CONSENT FORMS -->
    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
        <div class="flex items-start space-x-4 mb-6">
            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                <i class="fa-solid fa-file-signature text-purple-600 text-xl"></i>
            </div>
            <div>
                <h3 class="text-lg font-bold text-gray-900 mb-1">Additional Consent Forms</h3>
                <p class="text-sm text-gray-600">Manage additional regulatory and company-specific consent requirements</p>
            </div>
        </div>

        <!-- HIPAA CONSENT-->

@*         <div class="grid grid-cols-3 gap-4">
            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 cursor-pointer">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold">HIPAA Authorization</span>
                    <i class="fa-solid @(HipaaConsent ? "fa-check-circle text-green-500" : "fa-times-circle text-red-500")"></i>
                </div>
                <p class="text-xs text-gray-500 mb-2">Medical records access</p>
                <span class="text-xs text-gray-400">@(HipaaConsent ? "Provided" : "Not Provided")</span>
            </div>

            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 cursor-pointer">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold">E-Signature Consent</span>
                    <i class="fa-solid @(ESignatureConsent ? "fa-check-circle text-green-500" : "fa-times-circle text-red-500")"></i>
                </div>
                <p class="text-xs text-gray-500 mb-2">Electronic signature agreement</p>
                <span class="text-xs text-gray-400">@(ESignatureConsent ? "Provided" : "Not Provided")</span>
            </div>

            <div class="border border-gray-200 rounded-lg p-4 hover:border-blue-300 cursor-pointer">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-semibold">Marketing Consent</span>
                    <i class="fa-solid @(MarketingConsent ? "fa-check-circle text-green-500" : "fa-times-circle text-red-500")"></i>
                </div>
                <p class="text-xs text-gray-500 mb-2">Promotional communications</p>
                <span class="text-xs text-gray-400">@(MarketingConsent ? "Provided" : "Not Provided")</span>
            </div>
        </div>
    </div> *@

    <!-- COMPLIANCE STATUS -->
@*     <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-6 mb-6">
        <div class="flex items-center justify-between">

            <div class="flex items-center space-x-4">
                <div class="w-14 h-14 @GetOverallComplianceColor() rounded-full flex items-center justify-center">
                    <i class="fa-solid @GetOverallComplianceIcon() text-white text-2xl"></i>
                </div>

                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-1">Overall Compliance Status</h3>
                    <p class="text-sm text-gray-700">
                        TCPA: <strong>@Tcpa</strong> •
                        CCPA: <strong>@(IsCA? Ccpa : "N/A")</strong> •
                        ZIP: <strong>@Zip</strong>
                    </p>
                </div>
            </div>

            <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg">
                <i class="fa-solid fa-download mr-2"></i>
                Export Compliance Report
            </button>

        </div>
    </div> *@

    <!-- ACTION BUTTONS -->
@*     <div class="bg-white rounded-xl border border-gray-200 p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">Compliance Actions</h3>
        <div class="grid grid-cols-4 gap-4">

            <button class="border-2 border-gray-200 hover:border-blue-300 rounded-lg p-4 text-center transition-all group">
                <i class="fa-solid fa-rotate text-gray-400 group-hover:text-blue-600 text-2xl mb-2"></i>
                <p class="text-sm font-semibold text-gray-700 group-hover:text-blue-600">Re-Capture Consent</p>
            </button>

            <button class="border-2 border-gray-200 hover:border-blue-300 rounded-lg p-4 text-center transition-all group">
                <i class="fa-solid fa-envelope text-gray-400 group-hover:text-blue-600 text-2xl mb-2"></i>
                <p class="text-sm font-semibold text-gray-700 group-hover:text-blue-600">Send Consent Email</p>
            </button>

            <button class="border-2 border-gray-200 hover:border-blue-300 rounded-lg p-4 text-center transition-all group">
                <i class="fa-solid fa-print text-gray-400 group-hover:text-blue-600 text-2xl mb-2"></i>
                <p class="text-sm font-semibold text-gray-700 group-hover:text-blue-600">Print Forms</p>
            </button>

            <button class="border-2 border-gray-200 hover:border-red-400 rounded-lg p-4 text-center transition-all group">
                <i class="fa-solid fa-ban text-gray-400 group-hover:text-red-600 text-2xl mb-2"></i>
                <p class="text-sm font-semibold text-gray-700 group-hover:text-red-600">Revoke Consent</p>
            </button>

        </div>*@
    </div> 

</div>

@code {
    [Parameter] public TopicWorkflowContext? Context { get; set; }
    [Parameter] public string ActiveTab { get; set; } = "";

    // Context key lookups using correct keys from reference doc
    private string Tcpa => Context?.GetString("tcpa_consent", "tcpa_agreement", "phone_consent") ?? "N/A";
    private string TcpaTimestamp => Context?.GetString("tcpa_consent_timestamp", "consent_date") ?? "N/A";
    private string Zip => Context?.GetString("zip_code", "postal_code") ?? "N/A";
    private string Ccpa => Context?.GetString("ccpa_acknowledgment", "ccpa_consent") ?? "N/A";

    private bool HipaaConsent => Context?.GetBool("hipaa_consent", "hipaa_authorization") ?? false;
    private bool ESignatureConsent => Context?.GetBool("esignature_consent", "electronic_signature_agreement") ?? false;
    private bool MarketingConsent => Context?.GetBool("marketing_consent", "promotional_consent") ?? false;

    private bool IsCA {
        get {
            var zip = Zip;
            if (string.IsNullOrWhiteSpace(zip) || zip == "N/A") return false;

            // Remove any non-numeric characters
            var numericZip = new string(zip.Where(char.IsDigit).ToArray());

            if (int.TryParse(numericZip, out var zipCode)) {
                // California ZIP code ranges
                return (zipCode >= 90001 && zipCode <= 96162);
            }
            return false;
        }
    }

    private string GetConsentBadgeClass(string consent) {
        var normalized = consent.ToLowerInvariant();
        return normalized switch {
            "yes" or "true" or "granted" or "accepted" => "bg-green-100 text-green-700",
            "no" or "false" or "denied" or "rejected" => "bg-red-100 text-red-700",
            _ => "bg-gray-100 text-gray-600"
        };
    }

    private string GetConsentIcon(string consent) {
        var normalized = consent.ToLowerInvariant();
        return normalized switch {
            "yes" or "true" or "granted" or "accepted" => "fa-check-circle",
            "no" or "false" or "denied" or "rejected" => "fa-times-circle",
            _ => "fa-question-circle"
        };
    }

    private string GetConsentLabel(string consent) {
        var normalized = consent.ToLowerInvariant();
        return normalized switch {
            "yes" or "true" or "granted" or "accepted" => "GRANTED",
            "no" or "false" or "denied" or "rejected" => "DENIED",
            _ => "PENDING"
        };
    }

    private string GetOverallComplianceColor() {
        var tcpaOk = Tcpa.ToLowerInvariant() is "yes" or "true" or "granted" or "accepted";
        var ccpaOk = !IsCA || Ccpa.ToLowerInvariant() is "yes" or "true" or "acknowledged";

        if (tcpaOk && ccpaOk) return "bg-green-600";
        if (tcpaOk || ccpaOk) return "bg-yellow-600";
        return "bg-red-600";
    }

    private string GetOverallComplianceIcon() {
        var tcpaOk = Tcpa.ToLowerInvariant() is "yes" or "true" or "granted" or "accepted";
        var ccpaOk = !IsCA || Ccpa.ToLowerInvariant() is "yes" or "true" or "acknowledged";

        if (tcpaOk && ccpaOk) return "fa-circle-check";
        if (tcpaOk || ccpaOk) return "fa-exclamation-triangle";
        return "fa-times-circle";
    }
}