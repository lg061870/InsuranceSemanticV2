@using ConversaCore.TopicFlow
@using System.Collections.Generic

<div id="matched-products-panel" class="tab-content p-8 @(ActiveTab != "matched-products" ? "hidden" : "")">

    <!-- HEADER -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">Recommended Insurance Products</h2>
            <p class="text-sm text-gray-600 mt-1">
                @(MatchedProducts?.Count ?? 0) products matched based on client profile and preferences
            </p>
        </div>

        <!-- Sort & Filter Controls -->
        <div class="flex items-center space-x-3">
            <select class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option>Sort by: Best Match</option>
                <option>Lowest Premium</option>
                <option>Highest Coverage</option>
                <option>Most Popular</option>
            </select>

            <button class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:border-gray-400 transition-colors">
                <i class="fa-solid fa-filter mr-2"></i>
                Filters
            </button>
        </div>
    </div>

    <!-- PRODUCT GRID -->
    <div class="grid grid-cols-2 gap-5">

        @if (MatchedProducts != null && MatchedProducts.Any()) {
            @foreach (var product in MatchedProducts) {
                <div class="bg-white rounded-xl border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow">
                    <!-- Product Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-white">@product.Name</h3>
                                <p class="text-sm text-blue-100">@product.Description</p>
                            </div>
                            <div class="bg-white rounded-full px-3 py-1">
                                <span class="text-sm font-bold text-blue-600">@product.MatchScore%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Product Details -->
                    <div class="p-6">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Coverage Amount</p>
                                <p class="text-lg font-bold text-gray-900">@product.Coverage</p>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Monthly Premium</p>
                                <p class="text-lg font-bold text-gray-900">$@product.MonthlyPremium</p>
                            </div>
                        </div>

                        <!-- Match Score Bar -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-semibold text-gray-600">Match Score</span>
                                <span class="text-xs font-bold text-blue-600">@product.MatchScore%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="@GetMatchScoreColor(product.MatchScore) h-2 rounded-full transition-all"
                                     style="width: @product.MatchScore%"></div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex space-x-3">
                            <button class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg transition-colors text-sm">
                                <i class="fa-solid fa-file-lines mr-2"></i>
                                View Details
                            </button>
                            <button class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2.5 rounded-lg transition-colors text-sm">
                                <i class="fa-solid fa-heart mr-2"></i>
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            }
        }
        else {
            <!-- Loading State -->
            <div class="col-span-2 text-center py-12">
                <i class="fa-solid fa-circle-notch fa-spin text-blue-600 text-4xl mb-4"></i>
                <p class="text-gray-600 text-lg">Analyzing client profile and matching insurance products...</p>
                <p class="text-gray-500 text-sm mt-2">This may take a few moments</p>
            </div>
        }

    </div>

    @if (MatchedProducts != null && MatchedProducts.Any()) {
        <!-- PAGINATION -->
        <div class="mt-8 flex items-center justify-center space-x-2">

            <button class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <i class="fa-solid fa-chevron-left"></i>
            </button>

            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium">1</button>
            <button class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">2</button>
            <button class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">3</button>

            <button class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                <i class="fa-solid fa-chevron-right"></i>
            </button>

        </div>
    }

</div>

@code {
    [Parameter] public TopicWorkflowContext? Context { get; set; }
    [Parameter] public string ActiveTab { get; set; } = "";
    [Parameter] public List<ProductMatch>? MatchedProducts { get; set; }

    private string GetMatchScoreColor(int score) {
        return score switch {
            >= 90 => "bg-gradient-to-r from-green-400 to-green-600",
            >= 80 => "bg-gradient-to-r from-blue-400 to-blue-600",
            >= 70 => "bg-gradient-to-r from-yellow-400 to-yellow-600",
            _ => "bg-gradient-to-r from-gray-400 to-gray-600"
        };
    }
}