@using System.Text.Json
@using ConversaCore.TopicFlow
@using ConversaCore.Models
@using InsuranceAgent.Topics
@using InsuranceAgent.DomainTypes
@using System.Text.Json.Serialization
@using System.Reflection

@inject IJSRuntime JS
@inject ILogger<CustomerConsole>? Logger
@inherits ComponentBase

@if (IsVisible)
{
    <div class="customer-console">
        <!-- Header -->
        <header class="console-header">
            <h2>Customer Console</h2>
            <p>Real-time AI Qualification Progress</p>
            <button class="close-btn" @onclick="() => OnClose.InvokeAsync()">×</button>
        </header>

        <div class="console-body-vertical">
            <!-- PROGRESS + SUMMARY SECTION -->
            <section class="progress-section-grid">
                <div class="progress-steps">
                    <h3 class="section-title">Data Capture</h3>
                    @foreach (var step in progressSteps)
                    {
                        <div class="step-row @(step.Completed ? "done" : step.Active ? "active" : "pending")">
                            @if (step.Completed)
                            {
                                <i class="fa-solid fa-check-circle text-green-500"></i>
                            }
                            else if (step.Active)
                            {
                                <i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i>
                            }
                            else
                            {
                                <i class="fa-regular fa-circle text-gray-400"></i>
                            }
                            <span>@step.Label</span>
                        </div>
                    }

                    <div class="progress-bar-container mt-4">
                        <div class="progress-bar-fill" style="width:@($"{analysisProgress}%")"></div>
                    </div>
                </div>

                <!-- RIGHT: Summary Data -->
                <div class="summary-panel">
                    @if (!summaryCards.Any())
                    {
                        <p class="empty-summary">Captured data will appear here as you progress.</p>
                    }
                    else
                    {
                        @foreach (var card in summaryCards)
                        {
                            <div class="summary-card">
                                <h4>@card.Title</h4>
                                <ul>
                                    @foreach (var item in card.Data)
                                    {
                                        <li><strong>@item.Key:</strong> @item.Value</li>
                                    }
                                </ul>
                            </div>
                        }
                    }
                </div>
            </section>

            <!-- MATCHED PRODUCTS SECTION -->
            <section class="product-section-wide">
                <h3 class="section-title">Matched Products</h3>

                @if (isAnalyzing)
                {
                    <div class="skeleton-card"></div>
                    <div class="skeleton-card delay-1"></div>
                    <div class="skeleton-card delay-2"></div>
                }
                else if (matchedProducts.Any())
                {
                    <div class="product-grid">
                        @foreach (var p in matchedProducts)
                        {
                            <div class="product-card">
                                <div class="product-score">@p.MatchScore%</div>
                                <h4>@p.Name</h4>
                                <p>@p.Description</p>
                                <div class="product-meta">
                                    <span>@p.Coverage coverage</span>
                                    <span>$@p.MonthlyPremium/mo</span>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="empty-hint">Awaiting qualification data...</p>
                }
            </section>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; } = true;
    [Parameter] public EventCallback OnClose { get; set; }

    private TopicWorkflowContext? context;
    private bool isAnalyzing = true;
    private int analysisProgress = 0;

    private List<ProductMatch> matchedProducts = new();
    private List<SummaryCard> summaryCards = new();

    private readonly List<ProgressStep> progressSteps = new()
    {
        new("Collecting lead details", "lead_details_submitted"),
        new("Recording life goals", "life_goals_submitted"),
        new("Capturing coverage intent", "coverage_intent_submitted"),
        new("Collecting health information", "health_info_submitted"),
        new("Saving dependents data", "dependents_submitted"),
        new("Confirming employment", "employment_submitted"),
        new("Listing beneficiaries", "beneficiaries_submitted"),
        new("Verifying contact info", "contact_info_submitted"),
        new("Finalizing qualification", "qualification_complete")
    };

    // === Summary Data Cards ===
    private void AddSummaryData(string eventName, object? model)
    {
        try
        {
            if (model == null) return;

            var type = model.GetType();
            var props = type.GetProperties().Where(p => p.CanRead).ToList();

            var card = new SummaryCard
            {
                Title = stepLabelForEvent(eventName),
                Data = props.ToDictionary(p => p.Name, p => FormatValue(p.GetValue(model)))
            };

            summaryCards.Insert(0, card);
            if (summaryCards.Count > 10)
                summaryCards.RemoveAt(summaryCards.Count - 1);

            _ = InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[CustomerConsole] Error adding summary card: {ex.Message}");
        }
    }

    private static string FormatValue(object? value)
        => value switch
        {
            null => "—",
            IEnumerable<string> list => string.Join(", ", list),
            _ => value.ToString() ?? ""
        };

    private string stepLabelForEvent(string eventName)
        => progressSteps.FirstOrDefault(s => s.EventKey == eventName)?.Label ?? eventName;

    // === Event Bridge from Home.razor ===
    public async Task UpdateFromChatEvent(string eventName, object? eventData = null, TopicWorkflowContext? ctx = null) {
        await AnimateProgressListAsync(eventName);

        if (ctx != null)
            context = ctx;

        QualifiedCarriers? carriers = null;

        try {
            // === CASE A: eventData is directly the payload ===
            if (eventData is QualifiedCarriers qc) {
                carriers = qc;
                Console.WriteLine("[CustomerConsole] ✅ eventData is directly QualifiedCarriers.");
            }
            else {
                // === CASE B: eventData has a 'payload' property ===
                var payloadProp = eventData?.GetType().GetProperty("payload") ??
                                  eventData?.GetType().GetProperty("Payload"); // case-insensitive

                if (payloadProp != null) {
                    var payloadValue = payloadProp.GetValue(eventData);
                    Console.WriteLine($"[CustomerConsole] ⚙️ Found payload property of type: {payloadValue?.GetType().Name}");

                    switch (payloadValue) {
                        case QualifiedCarriers innerQc:
                            carriers = innerQc;
                            Console.WriteLine("[CustomerConsole] ✅ payload is QualifiedCarriers.");
                            break;

                        case JsonElement elem when elem.ValueKind == JsonValueKind.Object:
                            carriers = JsonSerializer.Deserialize<QualifiedCarriers>(elem.GetRawText());
                            Console.WriteLine("[CustomerConsole] ✅ payload was JsonElement, deserialized to QualifiedCarriers.");
                            break;

                        case string s:
                            carriers = JsonSerializer.Deserialize<QualifiedCarriers>(s);
                            Console.WriteLine("[CustomerConsole] ✅ payload was string, deserialized to QualifiedCarriers.");
                            break;

                        default:
                            Console.WriteLine($"[CustomerConsole] ⚠️ payload type {payloadValue?.GetType().Name} not handled.");
                            break;
                    }
                }
                else {
                    Console.WriteLine($"[CustomerConsole] ⚠️ No payload property found on type {eventData?.GetType().Name ?? "null"}.");
                }
            }
        } catch (Exception ex) {
            Console.WriteLine($"[CustomerConsole] ❌ Failed to extract carriers payload: {ex.Message}");
        }

        // === If we found carriers and it's from a semantic query ===
        if (carriers != null && carriers.Carriers != null && carriers.Carriers.Any()) {
            // Only update if this was a semantic query (payload not null)
            isAnalyzing = false;

            matchedProducts = carriers.Carriers.Select(c => new ProductMatch(
                c.CarrierName,
                c.ProductName ?? "Life Insurance Product",
                c.MatchScore ?? 80,
                c.EstimatedMonthlyPremium ?? 0,
                c.CoverageAmount ?? "N/A"
            )).ToList();

            await InvokeAsync(StateHasChanged);
        }
        else {
            // Keep previously matched products if this event had no payload (non-query event)
            Console.WriteLine("[CustomerConsole] 🟡 No payload or empty carriers — skipping matched product update.");
        }


        // === Otherwise, handle summary cards ===
        if (context == null) return;

        switch (eventName) {
            case "lead_details_submitted": AddSummaryData(eventName, context.GetValue<object>("LeadDetailsModel")); break;
            case "life_goals_submitted": AddSummaryData(eventName, context.GetValue<object>("LifeGoalsModel")); break;
            case "coverage_intent_submitted": AddSummaryData(eventName, context.GetValue<object>("CoverageIntentModel")); break;
            case "health_info_submitted": AddSummaryData(eventName, context.GetValue<object>("HealthInfoModel")); break;
            case "dependents_submitted": AddSummaryData(eventName, context.GetValue<object>("DependentsModel")); break;
            case "employment_submitted": AddSummaryData(eventName, context.GetValue<object>("EmploymentModel")); break;
            case "beneficiaries_submitted": AddSummaryData(eventName, context.GetValue<object>("BeneficiariesModel")); break;
            case "contact_info_submitted": AddSummaryData(eventName, context.GetValue<object>("ContactInfoModel")); break;
            case "qualification_complete":
                isAnalyzing = false;
                analysisProgress = 100;
                break;
        }

        await InvokeAsync(StateHasChanged);
    }



    // === Progress Animation ===
    private async Task AnimateProgressListAsync(string eventKey) {
        try {
            var normalizedKey = eventKey.Replace("_started", "_submitted", StringComparison.OrdinalIgnoreCase);
            int index = progressSteps.FindIndex(s => s.EventKey.Equals(normalizedKey, StringComparison.OrdinalIgnoreCase));
            if (index == -1) return;

            bool isStarted = eventKey.EndsWith("_started", StringComparison.OrdinalIgnoreCase);
            bool isSubmitted = eventKey.EndsWith("_submitted", StringComparison.OrdinalIgnoreCase);

            for (int i = 0; i < progressSteps.Count; i++) {
                var s = progressSteps[i];
                s.Completed = i < index || (isSubmitted && i == index);
                s.Active = (isStarted && i == index) || (isSubmitted && i == index + 1);
            }

            analysisProgress = (int)Math.Round(((double)(index + 1) / progressSteps.Count) * 100);

            await InvokeAsync(StateHasChanged);
        } catch (Exception ex) {
            Console.WriteLine($"[CustomerConsole] AnimateProgressListAsync error: {ex.Message}");
        }
    }
}

<style>
    /* === Layout === */
    .customer-console {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: #fafafa;
        padding: 1.5rem 2rem;
        border-radius: 1rem;
    }

    .console-header {
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .console-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }

        .console-header p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }

    /* === Stacked Sections === */
    .console-body-vertical {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    /* === Section Titles === */
    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
    }

    /* === Progress Section === */
    .progress-section {
        background: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        padding: 1.5rem 2rem;
    }

    /* === Two-Column Capture Layout === */
    .capture-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .capture-progress {
        border-right: 1px solid #f3f4f6;
        padding-right: 1.5rem;
    }

    .capture-summary {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding-left: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
    }

    /* === Step Rows === */
    .step-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        transition: color 0.3s ease;
    }

        .step-row i {
            width: 1rem;
            min-width: 1rem;
        }

        .step-row span {
            flex: 1;
        }

        .step-row.pending span {
            color: #9ca3af;
        }

        .step-row.active span {
            color: #2563eb;
            font-weight: 600;
        }

        .step-row.done span {
            color: #16a34a;
        }

    /* === Progress Bar === */
    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 9999px;
        overflow: hidden;
        margin-top: 1rem;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #2563eb);
        border-radius: 9999px;
        transition: width 0.6s ease-in-out;
    }

    /* === Data Summary Cards === */
    .summary-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 0.9rem 1rem;
        font-size: 0.875rem;
        animation: fadeIn 0.5s ease forwards;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .summary-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }

    .summary-card ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }

    .summary-card li {
        margin-bottom: 0.25rem;
        color: #374151;
        display: flex;
        justify-content: space-between;
    }

        .summary-card li strong {
            color: #111827;
            font-weight: 500;
            margin-right: 0.5rem;
        }

    /* === Product Section (Wide) === */
    .product-section-wide {
        background: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        padding: 1.5rem 2rem;
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.25rem;
    }

    /* === Product Card === */
    .product-card {
        background: #fff;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 1rem;
        animation: fadeIn 0.6s ease forwards;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .product-card h4 {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .product-card p {
            font-size: 0.875rem;
            color: #4b5563;
            margin-bottom: 0.75rem;
        }

        .product-card .product-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #6b7280;
        }

    .product-score {
        font-weight: 700;
        color: #2563eb;
        float: right;
    }

    /* === Skeleton Loader (slower) === */
    .skeleton-card {
        width: 100%;
        height: 120px;
        border-radius: 0.75rem;
        background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
        background-size: 200% 100%;
        animation: shimmer 4.5s infinite linear;
        margin-bottom: 1rem;
    }

        .skeleton-card.delay-1 {
            animation-delay: 0.5s;
        }

        .skeleton-card.delay-2 {
            animation-delay: 1s;
        }

    @@keyframes shimmer {
        0% {
            background-position: 200% 0;
        }

        100% {
            background-position: -200% 0;
        }
    }

    /* === Empty Placeholder === */
    .empty-hint {
        font-size: 0.875rem;
        color: #9ca3af;
        text-align: center;
        margin-top: 2rem;
    }

    /* === Animations === */
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* === Close Button === */
    .close-btn {
        background: transparent;
        border: none;
        font-size: 1.25rem;
        color: #9ca3af;
        cursor: pointer;
        transition: color 0.2s;
    }

        .close-btn:hover {
            color: #111827;
        }

    /* === Responsive Behavior === */
    @@media (max-width: 900px) {
        .capture-layout {
            grid-template-columns: 1fr;
        }

        .capture-progress {
            border-right: none;
            padding-right: 0;
            border-bottom: 1px solid #f3f4f6;
            padding-bottom: 1.5rem;
        }

        .capture-summary {
            padding-left: 0;
        }
    }

    /* === Progress Grid Layout === */
    .progress-section-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        background: #ffffff;
        border-radius: 0.75rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        padding: 1.5rem 2rem;
    }

    .progress-steps {
        display: flex;
        flex-direction: column;
    }

    .summary-panel {
        background: #f9fafb;
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        overflow-y: auto;
        max-height: 320px;
    }

    .summary-card {
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        animation: fadeIn 0.6s ease forwards;
    }

        .summary-card h4 {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            color: #1f2937;
        }

        .summary-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .summary-card li {
            font-size: 0.875rem;
            color: #374151;
            margin-bottom: 0.25rem;
        }

    .empty-summary {
        font-size: 0.875rem;
        color: #9ca3af;
        text-align: center;
        margin-top: 2rem;
    }

</style>
